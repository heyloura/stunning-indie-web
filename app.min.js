const _app={readonly:function(){return!_app.github.getPAT()},sectionTypes:{post:"post"},postTypes:{note:"note",article:"article",like:"like",reply:"reply",bookmark:"bookmark"},htmlIds:{hcardimg:"configuration_indieweb_author_hcard_img",hcardname:"configuration_indieweb_author_hcard_name",hcardnote:"configuration_indieweb_hcard_note",githubPat:"configuration_github_pat",githubBranch:"configuration_github_branch",githubFileName:"configuration_github_filename",githubPath:"configuration_github_path",githubRepo:"configuration_github_repository",postUrl:"post-url",postName:"post-name",postTags:"post-tags",postDomain:"post-domain",postTitle:"post-title",editorOutput:"editor-output",editorControls:"editor-controls",postId:"edit-post-id",postTypes:"post-types",settingsGithubPat:"configuration_githubpat_settings",settingsGeneral:"configuration_general_settings",settingsIndieWeb:"configuration_indieweb_settings",settingsGIthubAutoSave:"configuration_githubautosave_settings"},indieweb:{getMyImg:function(){return document.getElementById(_app.htmlIds.hcardimg).value},getMyName:function(){return document.getElementById(_app.htmlIds.hcardname).value}},github:{getPATInput:function(){return document.getElementById(_app.htmlIds.githubpat).value},getPAT:function(){return localStorage.getItem("small-web-pat")},getRepo:function(){return document.getElementById(_app.htmlIds.githubRepo).value},getBranch:function(){return document.getElementById(_app.htmlIds.githubBranch).value},getFileName:function(){return document.getElementById(_app.htmlIds.githubFileName).value},getPath:function(){return document.getElementById(_app.htmlIds.githubPath).value}},sectionIdLength:6,alphabet:"23456789abdegjkmnpqrvwxyz",post:{hide:function(){document.getElementById(_app.htmlIds.postUrl).style.display="none",document.getElementById(_app.htmlIds.postName).style.display="none",document.getElementById(_app.htmlIds.postDomain).style.display="none",document.getElementById(_app.htmlIds.postTitle).style.display="none"},clear:function(){document.getElementById(_app.htmlIds.postUrl).value="",document.getElementById(_app.htmlIds.postName).value="",document.getElementById(_app.htmlIds.postTags).value="",document.getElementById(_app.htmlIds.postDomain).value="",document.getElementById(_app.htmlIds.postTitle).value="",document.getElementById(_app.htmlIds.editorOutput).innerHTML="",document.getElementById(_app.htmlIds.postId).value=""},set:function(t,e,n,a,o,s,i){document.getElementById(_app.htmlIds.postUrl).value=a,document.getElementById(_app.htmlIds.postName).value=o,document.getElementById(_app.htmlIds.postTags).value=s,document.getElementById(_app.htmlIds.postDomain).value=n,document.getElementById(_app.htmlIds.postTitle).value=e,document.getElementById(_app.htmlIds.editorOutput).innerHTML=i,document.getElementById(_app.htmlIds.postId).value=t},getUrl:function(){return document.getElementById(_app.htmlIds.postUrl).value},getName:function(){return document.getElementById(_app.htmlIds.postName).value},getTags:function(){return document.getElementById(_app.htmlIds.postTags).value},getDomain:function(){return document.getElementById(_app.htmlIds.postDomain).value},getTitle:function(){return document.getElementById(_app.htmlIds.postTitle).value},getPostType:function(){return document.querySelector(`input[name="${_app.htmlIds.postTypes}"]:checked`).value},getPost:function(){return document.getElementById(_app.htmlIds.editorOutput).innerHTML},getEditPostId:function(){return document.getElementById(_app.htmlIds.postId).value},attributeIds:{type:"data-type",postType:"data-post-type",date:"data-post-date",content:"data-post-content",tags:"data-post-tags",title:"data-post-title",url:"data-post-url",domain:"data-post-domain",name:"data-post-name"}}};function logout(){localStorage.clear(),location.reload()}function savePAT(){_app.github.getPATInput()&&localStorage.setItem("small-web-pat",_app.github.getPATInput()),location.reload()}function checkAutoSaveConfig(){const t=`https://api.github.com/repos/${_app.github.getRepo()}/contents${_app.github.getPath()}${_app.github.getFileName()}`;let e="<!DOCTYPE html>"+document.getElementById("html").outerHTML;Base64.encode(e);const n=new XMLHttpRequest;n.open("GET",t,!0),n.setRequestHeader("Authorization","Bearer "+_app.github.getPAT()),n.onreadystatechange=function(){if(console.log(n.readyState),n.readyState==XMLHttpRequest.DONE){var t=JSON.parse(n.responseText);console.log(t),t.message&&t.message}},n.send()}function generateSectionId(){for(var t="",e=0;e<_app.sectionIdLength;e++)t+=_app.alphabet.charAt(Math.floor(Math.random()*_app.alphabet.length));return document.querySelectorAll("section").forEach((function(e,n,a){if(e.getAttribute("id")===t)return console.log("Duplicate alert, trying again"),generateSectionId()})),t}function generatePostFooter(t,e,n,a,o){let s=new Date(t).toISOString(),i=new Date(t).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),p=_app.post.getTags();return`<div class="e-content-footer">\n      ${n} on <a href="#${o}" class="u-url p-name">\n      <time class="dt-published" datetime="${s}">${i}</time>\n      </a> | ${a} ${e?"üì∑ photo":""} ${p?`| üè∑Ô∏è <span class="p-category">${p}</span>`:""}\n    </div>`}function generatePostHTML(t,e,n,a){let o=!1;t.includes("<img")&&(t.split("<img").forEach(((e,n)=>{0===n?t=e:t+='<img class="u-photo" '+e})),o=!0);const s=`<a class="p-author h-card" rel="author" href="/">\n          <img src="${_app.indieweb.getMyImg()}" class="u-photo"> \n          <span class="p-name">${_app.indieweb.getMyName()}</span>\n        </a>`;if("reply"===e){const e=`in repy to <a href="${_app.post.getUrl()}" class="u-in-reply-to">${_app.post.getName()}</a>`,i=generatePostFooter(a,o,"replied","üí¨ reply",n);return`<article class="h-entry">${s}${e}\n        <div class="e-content p-content">               \n          ${t}${i}\n        </div>    \n        </article>`}if("like"===e){const e=generatePostFooter(a,o,"liked","üëç like",n);return`<div class="h-entry">\n        <div class="h-cite u-like-of">\n            Liked <a class="u-url" href="${_app.post.getUrl()}">a post</a> by\n            <span class="p-author h-card">\n            <a class="u-url p-name" href="${_app.post.getDomain()}">${_app.post.getName()}</a>\n            </span>:\n            <blockquote class="e-content">\n                ${t}\n            </blockquote>\n            ${e}\n        </div>\n        </div>`}if("bookmark"===e){const e=generatePostFooter(a,o,"bookmarked","üîñ bookmark",n);return`<div class="h-entry">${s}\n          <a class="u-bookmark-of h-cite" href="${_app.post.getUrl()}">\n            ${_app.post.getTitle()}\n          </a>\n          ${t}${e}\n        </div>`}const i=generatePostFooter(a,o,"published","üìî note",n);return`<article class="h-entry">${s}\n        <div class="e-content p-content">               \n            ${t}${i}\n        </div>    \n        </article>`}function post(){const t=new Date,e=_app.post.getPostType(),n=generateSectionId(),a=_app.post.getPost(),o=Base64.encode(a),s=`/${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()}/${e}/${n}`;let i=document.createElement("section");const p=_app.post.getEditPostId();p?i.setAttribute("id",p):i.setAttribute("id",s),i.setAttribute(_app.post.attributeIds.type,_app.sectionTypes.post),i.setAttribute(_app.post.attributeIds.postType,e),i.setAttribute(_app.post.attributeIds.date,t.getTime()),i.setAttribute(_app.post.attributeIds.content,o),i.setAttribute(_app.post.attributeIds.tags,_app.post.getTags()),i.setAttribute(_app.post.attributeIds.title,_app.post.getTitle()),i.setAttribute(_app.post.attributeIds.url,_app.post.getUrl()),i.setAttribute(_app.post.attributeIds.domain,_app.post.getDomain()),i.setAttribute(_app.post.attributeIds.name,_app.post.getName());let l=document.createElement("div");l.setAttribute("id",(p||s)+"-content"),l.innerHTML=generatePostHTML(a,e,p||s,t.getTime()),i.prepend(l);let d=document.createElement("a");d.setAttribute("class","logged-in"),d.style.display=_app.readonly()?"none":"block",d.style.float="right",d.setAttribute("href","javascript:void(0)"),d.innerHTML="‚úèÔ∏è edit",d.setAttribute("onclick",`edit('${p||s}')`),i.prepend(d);let r=document.createElement("a");r.setAttribute("class","logged-in"),r.style.display=_app.readonly()?"none":"block",r.style.float="right",r.style.marginLeft="0.5em",r.setAttribute("href","javascript:void(0)"),r.innerHTML="üí£ delete",r.setAttribute("onclick",`deleteMe('${p||s}')`),i.prepend(r);let u=document.getElementById("main");p&&document.getElementById(p).remove(),u.prepend(i),_app.post.clear(),window.location.hash="stream"}function edit(t){const e=document.getElementById(t);if(document.getElementById("post-button").innerHTML="Save Changes",e){const n=e.getAttribute(_app.post.attributeIds.content),a=Base64.decode(n),o=e.getAttribute(_app.post.attributeIds.title),s=e.getAttribute(_app.post.attributeIds.domain),i=e.getAttribute(_app.post.attributeIds.url),p=e.getAttribute(_app.post.attributeIds.name),l=e.getAttribute(_app.post.attributeIds.tags);_app.post.set(t,o,s,i,p,l,a)}window.location.hash="post"}function deleteMe(t){confirm("Are you sure you want to delete this?")&&(document.getElementById(t).remove(),window.location.hash="stream")}function loadStream(){let t=document.getElementById("stream");t.innerHTML="";var e=document.querySelectorAll(`section[${_app.post.attributeIds.type}='${_app.sectionTypes.post}'][${_app.post.attributeIds.date}]`);null!=e&&null!=e&&e.length>0&&([].slice.call(e).sort((function(t,e){return new Date(t.getAttribute(_app.post.attributeIds.date))>new Date(e.getAttribute(_app.post.attributeIds.date))?1:new Date(e.getAttribute(_app.post.attributeIds.date))>t.getAttribute(_app.post.attributeIds.date)?-1:0})),e.forEach((e=>{let n=e.getAttribute("id"),a=document.getElementById(n+"-content");if(null!=a&&null!=a){let e=a.cloneNode(!0).childNodes;[].slice.call(e).forEach((e=>t.append(e)))}})))}Object.freeze(_app),Object.freeze(_app.sectionTypes),Object.freeze(_app.postTypes),Object.freeze(_app.indieweb),Object.freeze(_app.readonly),document.addEventListener("DOMContentLoaded",(function(){let t=location.hash.length>1?location.hash.substring(1,location.hash.length):location.hash;var e=window.location.href.replace(/^https?:\/\//,"");if(window.location.host!==e&&window.location.host+"/"!==e&&window.location.host+"/index.html"!==e||(window.location.hash="stream"),"#stream"===window.location.hash&&loadStream(),_app.readonly())document.getElementById(_app.htmlIds.settingsGeneral).remove(),document.getElementById(_app.htmlIds.settingsIndieWeb).remove(),document.getElementById(_app.htmlIds.settingsGIthubAutoSave).remove();else{document.getElementById(_app.htmlIds.settingsGithubPat).remove();let t=document.getElementsByClassName("logged-in");[].slice.call(t).forEach((t=>{t.style.display="inline-block"})),document.querySelectorAll(`input[name=${_app.htmlIds.postTypes}]`).forEach((t=>t.addEventListener("click",(function(t){_app.post.hide(),t.target&&t.target.matches("input[type='radio']")&&("reply"===t.target.value&&(document.getElementById(_app.htmlIds.postUrl).style.display="block",document.getElementById(_app.htmlIds.postName).style.display="block"),"like"===t.target.value&&(document.getElementById(_app.htmlIds.postUrl).style.display="block",document.getElementById(_app.htmlIds.postName).style.display="block",document.getElementById(_app.htmlIds.postDomain).style.display="block"),"bookmark"===t.target.value&&(document.getElementById(_app.htmlIds.postUrl).style.display="block",document.getElementById(_app.htmlIds.postTitle).style.display="block"))})))),_app.post.hide()}window.onhashchange=function(){t=location.hash.length>1?location.hash.substring(1,location.hash.length):location.hash,"stream"===t&&loadStream(),"post"!==t||_app.post.getEditPostId()||(document.getElementById("post-button").innerHTML="Post it!",_app.post.clear()),window.scrollTo(0,0)},document.querySelectorAll("input.config").forEach((t=>t.addEventListener("input",(function(){if(this.setAttribute("value",this.value),this.getAttribute("id")===_app.htmlIds.hcardimg&&(document.getElementById("hcard_img").innerHTML=this.value),this.getAttribute("id")===_app.htmlIds.hcardnote&&(document.getElementById("hcard_note").innerHTML=this.value),this.getAttribute("id")===_app.htmlIds.hcardimg&&(document.getElementById("hcard_img").src=this.value),"configuration_site_name"===this.getAttribute("id")&&(document.getElementById("site_name").innerHTML=this.value),"configuration_indieauth_email"===this.getAttribute("id")){var t=document.getElementById("indieauth-email");if(t)this.value?(t.setAttribute("href",`mailto:${this.value}`),t.innerHTML="üìß "+this.value):t.remove();else if(this.value){let t=document.createElement("a");t.setAttribute("id","indieauth-email"),t.setAttribute("rel","me"),t.setAttribute("href",`mailto:${this.value}`),t.innerHTML="üìß "+this.value,document.getElementById("profile").append(t)}}})))),Panagram.init({controls:"defaultControls",ctrElement:document.getElementById(_app.htmlIds.editorControls),outElement:document.getElementById(_app.htmlIds.editorOutput)});document.getElementById(_app.htmlIds.editorOutput).addEventListener("paste",(t=>{t.preventDefault();const e=t.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,e)}))}));
