const byId=function(t){return document.getElementById(t)},_app={readonly:function(){return!_app.github.getPAT()},sectionTypes:{post:"post"},postTypes:{note:"note",article:"article",like:"like",reply:"reply",bookmark:"bookmark",photo:"photo"},htmlIds:{hcardimg:"configuration_indieweb_author_hcard_img",hcardname:"configuration_indieweb_author_hcard_name",hcardnote:"configuration_indieweb_hcard_note",githubPat:"configuration_github_pat",githubBranch:"configuration_github_branch",githubFileName:"configuration_github_filename",githubPath:"configuration_github_path",githubRepo:"configuration_github_repository",postUrl:"post-url",postName:"post-name",postTags:"post-tags",postDomain:"post-domain",postTitle:"post-title",editorOutput:"editor-output",editorControls:"editor-controls",postId:"edit-post-id",postTypes:"post-types",settingsGithubPat:"configuration_githubpat_settings",settingsGeneral:"configuration_general_settings",settingsIndieWeb:"configuration_indieweb_settings",settingsGIthubAutoSave:"configuration_githubautosave_settings",filter:"filter",filterText:"filterText",removeFilterText:"removeFilterText"},indieweb:{getMyImg:function(){return byId(_app.htmlIds.hcardimg).value},getMyName:function(){return byId(_app.htmlIds.hcardname).value}},github:{getPATInput:function(){return byId(_app.htmlIds.githubpat).value},getPAT:function(){return localStorage.getItem("small-web-pat")},getRepo:function(){return byId(_app.htmlIds.githubRepo).value},getBranch:function(){return byId(_app.htmlIds.githubBranch).value},getFileName:function(){return byId(_app.htmlIds.githubFileName).value},getPath:function(){return byId(_app.htmlIds.githubPath).value}},sectionIdLength:6,alphabet:"23456789abdegjkmnpqrvwxyz",post:{hide:function(){byId(_app.htmlIds.postUrl).style.display="none",document.querySelector(`[for='${_app.htmlIds.postUrl}']`).style.display="none",byId(_app.htmlIds.postName).style.display="none",document.querySelector(`[for='${_app.htmlIds.postName}']`).style.display="none",byId(_app.htmlIds.postDomain).style.display="none",document.querySelector(`[for='${_app.htmlIds.postDomain}']`).style.display="none",byId(_app.htmlIds.postTitle).style.display="none",document.querySelector(`[for='${_app.htmlIds.postTitle}']`).style.display="none"},clear:function(){byId(_app.htmlIds.postUrl).value="",byId(_app.htmlIds.postName).value="",byId(_app.htmlIds.postTags).value="",byId(_app.htmlIds.postDomain).value="",byId(_app.htmlIds.postTitle).value="",byId(_app.htmlIds.editorOutput).innerHTML="",byId(_app.htmlIds.postId).value=""},set:function(t,e,a,o,p,s,n){byId(_app.htmlIds.postUrl).value=o,byId(_app.htmlIds.postName).value=p,byId(_app.htmlIds.postTags).value=s,byId(_app.htmlIds.postDomain).value=a,byId(_app.htmlIds.postTitle).value=e,byId(_app.htmlIds.editorOutput).innerHTML=n,byId(_app.htmlIds.postId).value=t},getUrl:function(){return byId(_app.htmlIds.postUrl).value},getName:function(){return byId(_app.htmlIds.postName).value},getTags:function(){return byId(_app.htmlIds.postTags).value},getDomain:function(){return byId(_app.htmlIds.postDomain).value},getTitle:function(){return byId(_app.htmlIds.postTitle).value},getPostType:function(){return document.querySelector(`input[name="${_app.htmlIds.postTypes}"]:checked`).value},getPost:function(){return byId(_app.htmlIds.editorOutput).innerHTML},getEditPostId:function(){return byId(_app.htmlIds.postId).value},attributeIds:{type:"data-type",postType:"data-post-type",date:"data-post-date",content:"data-post-content",tags:"data-post-tags",title:"data-post-title",url:"data-post-url",domain:"data-post-domain",name:"data-post-name",photo:"data-post-has-photo"}}};function logout(){localStorage.clear(),location.reload()}function savePAT(){_app.github.getPATInput()&&localStorage.setItem("small-web-pat",_app.github.getPATInput()),location.reload()}function autoSave(){byId(_app.htmlIds.editorControls).innerHTML="";const t=`https://api.github.com/repos/${_app.github.getRepo()}/contents${_app.github.getPath()}${_app.github.getFileName()}?ref=${_app.github.getBranch()}`;let e="<!DOCTYPE html>"+byId("html").outerHTML,a=Base64.encode(e);Panagram.init({controls:"defaultControls",ctrElement:byId(_app.htmlIds.editorControls),outElement:byId(_app.htmlIds.editorOutput)});const o=new XMLHttpRequest;o.open("GET",t,!0),o.setRequestHeader("Authorization","Bearer "+_app.github.getPAT()),o.onreadystatechange=function(){if(o.readyState==XMLHttpRequest.DONE){var e=JSON.parse(o.responseText);if(e.message&&"Not Found"===e.message)return void alert("Could not find: "+t);if(e.sha){let o={message:"Checking auto save config",content:a,sha:e.sha,branch:_app.github.getBranch()};const p=new XMLHttpRequest;p.open("PUT",t,!0),p.setRequestHeader("Authorization","Bearer "+_app.github.getPAT()),p.setRequestHeader("Content-Type","application/vnd.github+json"),p.onreadystatechange=function(){p.readyState==XMLHttpRequest.DONE&&(JSON.parse(p.responseText).commit||alert("Something went wrong ..."))},p.send(JSON.stringify(o))}}},o.send()}function generateSectionId(){for(var t="",e=0;e<_app.sectionIdLength;e++)t+=_app.alphabet.charAt(Math.floor(Math.random()*_app.alphabet.length));return document.querySelectorAll("section").forEach((function(e,a,o){if(e.getAttribute("id")===t)return generateSectionId()})),t}function filterResults(t){byId(_app.htmlIds.filterText).innerHTML=t,byId(_app.htmlIds.filter).style.display="block",loadPostType(window.location.hash.slice(1))}function generatePostFooter(t,e,a,o,p,s){let n=new Date(t).toISOString(),i=new Date(t).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),l=_app.post.getTags(),r="";if(l){let t=l.split(",");r='| üè∑Ô∏è <span class="p-category">',t.forEach((function(e,a){r+=`<a onclick="filterResults('${e}')" href="javascript:void(0)">${e}</a>`,a!=t.length-1&&(r+=",&nbsp;")})),r+="</span>"}return`<div class="e-content-footer">\n      ${a} on <a href="#${p}" class="u-url p-name">\n      <time class="dt-published" datetime="${n}">${i}</time>\n      </a> | ${`<a href='#${s}'>${o}</a>`} ${e?"<a href='#photo'>üì∑ photo</a>":""} ${r}\n    </div>`}function generatePostHTML(t,e,a,o){let p=!1;t.includes("<img")&&(t.split("<img").forEach(((e,a)=>{0===a?t=e:t+='<img class="u-photo" '+e})),p=!0);const s=`<a class="p-author h-card" rel="author" href="/">\n          <img src="${_app.indieweb.getMyImg()}" class="u-photo"> \n          <span class="p-name">${_app.indieweb.getMyName()}</span>\n        </a>`;if("reply"===e){const e=`in repy to <a href="${_app.post.getUrl()}" class="u-in-reply-to">${_app.post.getName()}</a>`,n=generatePostFooter(o,p,"replied","üí¨ reply",a,_app.postTypes.reply);return`<article class="h-entry">${s}${e}\n        <div class="e-content p-content">               \n          ${t}${n}\n        </div>    \n        </article>`}if("like"===e){const e=generatePostFooter(o,p,"liked","üëç like",a,_app.postTypes.like);return`<div class="h-entry">\n        <div class="h-cite u-like-of">\n            Liked <a class="u-url" href="${_app.post.getUrl()}">a post</a> by\n            <span class="p-author h-card">\n            <a class="u-url p-name" href="${_app.post.getDomain()}">${_app.post.getName()}</a>\n            </span>:\n            <blockquote class="e-content">\n                ${t}\n            </blockquote>\n            ${e}\n        </div>\n        </div>`}if("bookmark"===e){const e=generatePostFooter(o,p,"bookmarked","üîñ bookmark",a,_app.postTypes.bookmark);return`<div class="h-entry">${s}\n          <a class="u-bookmark-of h-cite" href="${_app.post.getUrl()}">\n            ${_app.post.getTitle()}\n          </a>\n          ${t}${e}\n        </div>`}const n=generatePostFooter(o,p,"published","üìî note",a,_app.postTypes.note);return`<article class="h-entry">${s}\n        <div class="e-content p-content">               \n            ${t}${n}\n        </div>    \n        </article>`}function post(){const t=new Date,e=_app.post.getPostType(),a=generateSectionId(),o=_app.post.getPost(),p=o.includes("üì∑ photo"),s=Base64.encode(o),n=`/${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()}/${e}/${a}`;let i=document.createElement("section");const l=_app.post.getEditPostId();l?i.setAttribute("id",l):i.setAttribute("id",n),i.setAttribute(_app.post.attributeIds.type,_app.sectionTypes.post),i.setAttribute(_app.post.attributeIds.postType,e),i.setAttribute(_app.post.attributeIds.date,t.getTime()),i.setAttribute(_app.post.attributeIds.content,s),i.setAttribute(_app.post.attributeIds.tags,_app.post.getTags()),i.setAttribute(_app.post.attributeIds.title,_app.post.getTitle()),i.setAttribute(_app.post.attributeIds.url,_app.post.getUrl()),i.setAttribute(_app.post.attributeIds.domain,_app.post.getDomain()),i.setAttribute(_app.post.attributeIds.name,_app.post.getName()),i.setAttribute(_app.post.attributeIds.photo,p);let r=document.createElement("div");r.setAttribute("id",(l||n)+"-content"),r.innerHTML=generatePostHTML(o,e,l||n,t.getTime()),i.prepend(r);let d=document.createElement("a");d.setAttribute("class","logged-in"),d.style.display=_app.readonly()?"none":"block",d.style.float="right",d.setAttribute("href","javascript:void(0)"),d.innerHTML="‚úèÔ∏è edit",d.setAttribute("onclick",`edit('${l||n}')`),i.prepend(d);let u=document.createElement("a");u.setAttribute("class","logged-in"),u.style.display=_app.readonly()?"none":"block",u.style.float="right",u.style.marginLeft="0.5em",u.setAttribute("href","javascript:void(0)"),u.innerHTML="üí£ delete",u.setAttribute("onclick",`deleteMe('${l||n}')`),i.prepend(u);let c=byId("main");l&&byId(l).remove(),c.prepend(i),_app.post.clear(),autoSave(),window.location.hash="stream"}function edit(t){const e=byId(t);if(byId("post-button").innerHTML="Save Changes",e){const a=e.getAttribute(_app.post.attributeIds.content),o=Base64.decode(a),p=e.getAttribute(_app.post.attributeIds.title),s=e.getAttribute(_app.post.attributeIds.domain),n=e.getAttribute(_app.post.attributeIds.url),i=e.getAttribute(_app.post.attributeIds.name),l=e.getAttribute(_app.post.attributeIds.tags);_app.post.set(t,p,s,n,i,l,o)}window.location.hash="post"}function deleteMe(t){confirm("Are you sure you want to delete this?")&&(byId(t).remove(),window.location.hash="stream")}function loadStream(){let t=byId("stream");t.innerHTML="";var e=document.querySelectorAll(`section[${_app.post.attributeIds.type}='${_app.sectionTypes.post}'][${_app.post.attributeIds.date}]`);null!=e&&null!=e&&e.length>0&&([].slice.call(e).sort((function(t,e){return new Date(t.getAttribute(_app.post.attributeIds.date))>new Date(e.getAttribute(_app.post.attributeIds.date))?1:new Date(e.getAttribute(_app.post.attributeIds.date))>t.getAttribute(_app.post.attributeIds.date)?-1:0})),e.forEach((e=>{let a=e.getAttribute("id"),o=byId(a+"-content");if(null!=o&&null!=o){let e=o.cloneNode(!0).childNodes;[].slice.call(e).forEach((e=>t.append(e)))}})))}function loadPostType(t){let e=byId(t);e.innerHTML="";let a=byId(_app.htmlIds.filterText),o=a.innerHTML?`[${_app.post.attributeIds.tags}~=${a.innerHTML}]`:"",p=null;p=t===_app.postTypes.photo?document.querySelectorAll(`section[${_app.post.attributeIds.photo}='true'][${_app.post.attributeIds.date}]${o}`):document.querySelectorAll(`section[${_app.post.attributeIds.postType}='${t}'][${_app.post.attributeIds.date}]${o}`),null!=p&&null!=p&&p.length>0&&([].slice.call(p).sort((function(t,e){return new Date(t.getAttribute(_app.post.attributeIds.date))>new Date(e.getAttribute(_app.post.attributeIds.date))?1:new Date(e.getAttribute(_app.post.attributeIds.date))>t.getAttribute(_app.post.attributeIds.date)?-1:0})),p.forEach((t=>{let a=t.getAttribute("id"),o=byId(a+"-content");if(null!=o&&null!=o){let t=o.cloneNode(!0).childNodes;[].slice.call(t).forEach((t=>e.append(t)))}})))}Object.freeze(_app),Object.freeze(_app.sectionTypes),Object.freeze(_app.postTypes),Object.freeze(_app.indieweb),Object.freeze(_app.readonly),document.addEventListener("DOMContentLoaded",(function(){let t=window.location.hash.slice(1);var e=window.location.href.replace(/^https?:\/\//,"");if(window.location.host!==e&&window.location.host+"/"!==e&&window.location.host+"/index.html"!==e||(window.location.hash="stream"),"#stream"===window.location.hash&&loadStream(),byId(_app.htmlIds.removeFilterText).addEventListener("click",(function(t){byId(_app.htmlIds.filterText).innerHTML="",byId(_app.htmlIds.filter).style.display="none"})),_app.readonly())byId(_app.htmlIds.settingsGeneral).remove(),byId(_app.htmlIds.settingsIndieWeb).remove(),byId(_app.htmlIds.settingsGIthubAutoSave).remove();else{byId(_app.htmlIds.settingsGithubPat).remove();let t=document.getElementsByClassName("logged-in");[].slice.call(t).forEach((t=>{t.style.display="inline-block"})),document.querySelectorAll(`input[name=${_app.htmlIds.postTypes}]`).forEach((t=>t.addEventListener("click",(function(t){_app.post.hide(),t.target&&t.target.matches("input[type='radio']")&&("reply"===t.target.value&&(byId(_app.htmlIds.postUrl).style.display="block",document.querySelector(`[for='${_app.htmlIds.postUrl}']`).style.display="block",byId(_app.htmlIds.postName).style.display="block",document.querySelector(`[for='${_app.htmlIds.postName}']`).style.display="block"),"like"===t.target.value&&(byId(_app.htmlIds.postUrl).style.display="block",document.querySelector(`[for='${_app.htmlIds.postUrl}']`).style.display="block",byId(_app.htmlIds.postName).style.display="block",document.querySelector(`[for='${_app.htmlIds.postName}']`).style.display="block",byId(_app.htmlIds.postDomain).style.display="block",document.querySelector(`[for='${_app.htmlIds.postDomain}']`).style.display="block"),"bookmark"===t.target.value&&(byId(_app.htmlIds.postUrl).style.display="block",document.querySelector(`[for='${_app.htmlIds.postUrl}']`).style.display="block",byId(_app.htmlIds.postTitle).style.display="block",document.querySelector(`[for='${_app.htmlIds.postTitle}']`).style.display="block"))})))),_app.post.hide()}window.onhashchange=function(){t=window.location.hash.slice(1),"stream"===t&&loadStream(),t!==_app.postTypes.note&&t!==_app.postTypes.reply&&t!==_app.postTypes.like&&t!==_app.postTypes.bookmark&&t!==_app.postTypes.photo||loadPostType(t),"post"!==t||_app.post.getEditPostId()||(byId("post-button").innerHTML="Post it!",_app.post.clear()),window.scrollTo(0,0)},document.querySelectorAll("input.config").forEach((t=>t.addEventListener("input",(function(){if(this.setAttribute("value",this.value),this.getAttribute("id")===_app.htmlIds.hcardname&&(byId("hcard_name").innerHTML=this.value),this.getAttribute("id")===_app.htmlIds.hcardnote&&(byId("hcard_note").innerHTML=this.value),this.getAttribute("id")===_app.htmlIds.hcardimg&&(byId("hcard_img").src=this.value),"configuration_site_name"===this.getAttribute("id")&&(byId("site_name").innerHTML=this.value),"configuration_indieauth_email"===this.getAttribute("id")){var t=byId("indieauth-email");if(t)this.value?(t.setAttribute("href",`mailto:${this.value}`),t.innerHTML="üìß "+this.value):t.remove();else if(this.value){let t=document.createElement("a");t.setAttribute("id","indieauth-email"),t.setAttribute("rel","me"),t.setAttribute("href",`mailto:${this.value}`),t.style.display="block",t.style.textAlign="center",t.innerHTML="üìß "+this.value,byId("profile").append(t)}}})))),Panagram.init({controls:"defaultControls",ctrElement:byId(_app.htmlIds.editorControls),outElement:byId(_app.htmlIds.editorOutput)});byId(_app.htmlIds.editorOutput).addEventListener("paste",(t=>{t.preventDefault();const e=t.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,e)}))}));
